"use strict";var pushy=new pushy,pleni=angular.module("PleniApp",["ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/search"),a.state("search",{url:"/search",templateUrl:"pages/search",data:{view:"search"}}).state("sitemap",{url:"/sitemap",templateUrl:"pages/sitemap",data:{view:"sitemap"}}).state("about",{url:"/about",templateUrl:"pages/about"}).state("report",{url:"/report",templateUrl:"pages/report"})}]),utils={show:function(a,b){var b='<div class="message '+a+'"><div class="close"><a onclick=\'utils.hide(this)\' class="fa fa-close"></a></div><p>'+b+"</p></div>";$(".messages").append(b).show("slow")},hide:function(a){$(a).parent().parent().slideUp("slow",function(){$(this).remove()})},clean:function(){$(".messages").hide("fast").empty()}};pleni.controller("SitesController",["$scope","$rootScope","$state","$http","$window","$location","Visual",function(a,b,c,d,e,f,g){a.$state=c,a.status={view:"",url:"",completed:0,total:0,message:"",waiting:!1},a.menu={settings:[1,0,0,0,1],show:function(b){return a.menu.settings[b]},open:function(){pushy.togglePushy()},hide:function(){pushy.togglePushy()},refresh:function(){e.location.reload()},about:function(){pushy.togglePushy(),a.menu.settings=[1,0,0,0,1],c.go("about")},home:function(){switch(a.status.view){case"search":a.menu.settings=[1,0,0,0,1];break;case"sitemap":a.menu.settings=[1,1,0,1,1]}c.go(a.status.view)},close:function(){pushy.togglePushy(),c.go("search"),d["delete"]("/").success(function(){a.menu.refresh()})},more:function(){pushy.togglePushy(),a.status.completed==a.status.total?a.status.messsage="You have already completed the analysis of the site":d.put("/more").success(function(b){a.status.waiting=!0,a.status.message=b.msg}).error(function(){a.status.message="Waiting for the completion of previous tasks"})},report:function(){pushy.togglePushy(),a.menu.settings=[1,0,0,0,1],d.put("/report").success(function(b){a.status.waiting=!0,a.status.message=b.msg,c.go("report")}).error(function(){a.status.message="Waiting for the completion of previous tasks"})}},a.search={url:"",send:function(){utils.clean(),""!=a.search.url?(a.status.message="Sending a request for fetch",d.put("/sites",{site:a.search.url,agent:navigator.userAgent}).success(function(b){$("footer").fadeOut("slow",function(){$(".main").fadeOut("slow",function(){$("#content").removeClass("blocked"),$(this).remove(),a.status.waiting=!0,a.status.message=b.msg,0!=b.queue&&(a.status.message+=" (waiting for :"+b.queue+" tasks)"),c.go("sitemap")}),$(this).remove()})}).error(function(a){switch(a.message){case"Validation error":utils.show("error","The url is not a valid host");break;case"Resource is busy":utils.show("error","Waiting for the completion of previous tasks")}})):utils.show("error","The URL is empty")}},a.sitemap={load:function(){var b=/pleni.site.url=(.+)/.exec(document.cookie);return b?(a.status.url=decodeURIComponent(b[1]),void d.post("/sitemap").success(function(b){g.clean(),b&&b.ok?g.render():(a.status.completed=b.count,a.status.total=b.total,g.render(b))})):(utils.show("error","The url is not a valid host"),void(a.status.message="You have not set a website to analyze"))}},b.$on("$stateChangeSuccess",function(b,c){if(c.data&&c.data.view)switch(c.data.view){case"search":a.status.view="search",a.menu.settings=[1,0,0,0,1],setTimeout(function(){$("input[type='text']").focus()},500);break;case"sitemap":a.status.view="sitemap",a.menu.settings=[1,1,0,1,1],a.sitemap.load()}}),a.socket=io.connect("",{reconnect:!0,forceNew:!0}),a.socket.on("notifier",function(b){switch(b.msg&&(a.status.message=b.msg),b.action){case"task":"site/fetch"==b.task.id&&(b.task.msg.node?(g.add({page:b.task.msg.node.page,status:b.task.msg.node.status,mime:b.task.msg.node.mime,get:b.task.msg.node.get,type:b.task.msg.node.type},b.task.msg.node.rel),a.status.message="GET "+b.task.msg.node.page+" "+b.task.msg.node.status+". links founded: "+b.task.msg.node.rel.length,a.status.completed++,a.status.total=visual.nodes.length):"completed"==b.task.msg&&(a.status.waiting=!1));break;case"stop":a.status.waiting=!1}a.$apply()})}]);var visual={init:function(){visual.tip=d3.tip().attr("class","tooltip").html(function(a){return'<div class="title">'+a.page+'</div><div class="subtle">'+(a.get?"✓":"✕")+'</div><div class="subtle">'+a.mime+"</div>"}).direction("n"),visual.canvas=document.getElementById("canvas"),visual.vis=d3.select("#canvas").append("svg:svg").attr("width","100%").attr("height","100%").attr("preserveAspectRatio","xMidYMid meet").attr("pointer-events","all").call(d3.behavior.zoom().on("zoom",function(){visual.vlinks.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),visual.vnodes.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")})).call(visual.tip),visual.vlinks=visual.vis.append("svg:g").attr("class","links"),visual.vnodes=visual.vis.append("svg:g").attr("class","nodes"),visual.legend=d3.select("#canvas").append("svg:svg").attr("width","250px"),visual.link,visual.node,visual.force=d3.layout.force().size([visual.canvas.clientWidth,visual.canvas.clientHeight]).linkDistance(200).linkStrength(1).friction(.5).charge(-2e3).gravity(.1).on("tick",visual.tick),visual.drag=visual.force.drag().on("dragstart",function(a){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("fixed",a.fixed=!0)})},tick:function(){visual.link.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),visual.node.call(function(){this.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})})},set:function(a,b,c){visual.count=a,visual.nodes=b,visual.links=c,b[0].x=~~(visual.canvas.clientWidth/2)-9,b[0].y=~~(visual.canvas.clientHeight/2)-9,b[0].fixed=!0,visual.adjacency1={},visual.adjacency2={},visual.links.forEach(function(a){visual.adjacency1[a.source.index+"_"+a.target.index]=!0,visual.adjacency2[a.target.index+"_"+a.source.index]=!0}),visual.hash1={},visual.hash2={},visual.mimes=new Array;for(var d=0;d<b.length;d++)visual.hash1[b[d].page]=d,visual.add_hash2(b[d])},add_hash2:function(a){a.mime in visual.hash2?visual.hash2[a.mime]++:(visual.hash2[a.mime]=1,visual.mimes.push(a.mime))},linked:function(a,b){return a.index+"_"+b.index in visual.adjacency1},linkin:function(a,b){return a.index+"_"+b.index in visual.adjacency2},draw:function(){visual.link=visual.vis.select(".links").selectAll("line").data(visual.links,function(a,b){return b}),visual.node=visual.vis.select(".nodes").selectAll("circle").data(visual.nodes,function(a,b){return b}),visual.link.enter().append("line").attr("class","link"),visual.link.exit().remove(),visual.node.enter().append("circle").attr("r",function(a){switch(a.type){case"root":return 18;case"page":return 12;default:return 6}}).attr("class",function(a){return["node",a.type,function(a){return"s-"+~~(a/100)}(a.status),function(a){return"m-"+a.replace("/","-")}(a.mime)].join(" ")}).on("dblclick",function(a){d3.select(this).classed("fixed",a.fixed=!1)}).on("mouseover",function(a){visual.tip.show(a),visual.link.classed("highlighted1",function(b){return b.source.index==a.index?!0:!1}),visual.link.classed("highlighted2",function(b){return b.target.index==a.index?!0:!1})}).on("mouseout",function(a){visual.tip.hide(a),visual.node.style("opacity",1),visual.link.classed("highlighted1",!1),visual.link.classed("highlighted2",!1)}).call(visual.drag),visual.node.exit().remove(),visual.force.nodes(visual.nodes).links(visual.links).start()},panel:function(){visual.legend.selectAll(".legend").remove();var a=visual.legend.selectAll(".legend").data(visual.mimes.sort()),b=a.enter().append("g").attr("class","legend").attr("transform",function(a,b){return"translate(0,"+22*b+")"});b.append("rect").attr("x",0).attr("y",0).attr("width",14).attr("height",14).attr("class",function(a){return"m-"+a.replace("/","-")}),b.append("text").attr("x",20).attr("y",11).attr("width",180).attr("height",14).text(function(a){return a}),b.append("text").attr("x",230).attr("y",11).style("text-anchor","end").text(function(a){return visual.hash2[a]}),a.exit().remove(),visual.legend.attr("height",22*visual.mimes.length+4+"px")},load:function(a){d3.json(a,function(a){visual.init(),visual.set(a.count,a.nodes,a.links),visual.draw(),visual.panel()})},add:function(a,b){var c,d;a.page in visual.hash1?(c=visual.hash1[a.page],a.mime!=visual.nodes[c]&&(visual.hash2[visual.nodes[c].mime]--,visual.add_hash2(a)),visual.nodes[c].page=a.page,visual.nodes[c].status=a.status,visual.nodes[c].mime=a.mime,visual.nodes[c].get=a.get,visual.nodes[c].type=a.type,d3.select("g.nodes>circle:nth-child("+(c+1)+")").attr("r",function(a){switch(a.type){case"root":return 18;case"page":return 12;default:return 6}}).attr("class",function(a){return["node",a.type,function(a){return"s-"+~~(a/100)}(a.status),function(a){return"m-"+a.replace("/","-")}(a.mime)].join(" ")})):(c=visual.nodes.length,visual.nodes.push(a),visual.hash1[a.page]=c,visual.add_hash2[a]),b.forEach(function(a){if(a in visual.hash1)d=visual.hash1[a];else{var b={page:a,status:"unknown",mime:"unknown",get:!1,type:"unknown"};d=visual.nodes.length,visual.nodes.push(b),visual.hash1[a]=d,visual.add_hash2(b)}visual.links.push({source:c,target:d}),visual.adjacency1[c+"_"+d]=!0,visual.adjacency2[d+"_"+c]=!0}),visual.draw(),visual.panel()}};pleni.factory("Visual",[function(){var a={page:"/",status:"unknown",mime:"unknown",get:!1,type:"unknown"},b={count:1,nodes:[a],links:[]};return{clean:function(){$("#canvas").empty()},render:function(a){a||(a=b),visual.init(),visual.set(a.count,a.nodes,a.links),visual.draw(),visual.panel()},add:function(a,b){visual.add(a,b)}}}]);