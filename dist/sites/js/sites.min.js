"use strict";var pushy=new pushy,pleni=angular.module("PleniApp",["ngRoute"]).config(["$routeProvider",function(a){var b=/pleni.url=(.+)/.exec(document.cookie),c="/sites";b&&2==b.length&&(c="/map"),a.when("/sites",{templateUrl:"/sites",controller:"SitesController"}).when("/map",{templateUrl:"/map",controller:"MapController"}).when("/about",{templateUrl:"/about"}).when("/report",{templateUrl:"/report",controller:"ReportController"}).otherwise({redirectTo:c})}]);pleni.controller("SitesController",["$scope","$rootScope","$http","$location",function(a,b,c,d){a.message="",a.url="",$("input[type='text']").focus(),a.send=function(){utils.clean(),""!=a.url?c.put("/sites",{site:a.url,agent:navigator.userAgent}).success(function(a){$("footer").fadeOut("slow",function(){$(".main").fadeOut("slow",function(){$("#content").removeClass("blocked"),$(this).remove()}),$(this).remove()}),b.monitor=a.msg+" ",b.monitor+=0==a.queue?". starting ...":"(aprox:"+a.queue+" minutes)",d.path("/map")}).error(function(){utils.show("error","The url is not a valid host")}):utils.show("error","The url is empty")}}]);var utils={show:function(a,b){var b='<div class="message '+a+'"><div class="close"><a onclick=\'utils.hide(this)\' class="fa fa-close"></a></div><p>'+b+"</p></div>";$(".messages").append(b).show("slow")},hide:function(a){$(a).parent().parent().slideUp("slow",function(){$(this).remove()})},clean:function(){$(".messages").hide("fast").empty()}};pleni.controller("MapController",["$scope","$rootScope","$http","$location","Visual",function(a,b,c,d,e){a.completed=0,a.total=0,a.message=b.monitor,a.waiting=!0,$("#content").removeClass("blocked");var f=/pleni.url=(.+)/.exec(document.cookie);f&&2==f.length?(a.url=decodeURIComponent(f[1]),c.post("/mapsite").success(function(b){e.clean(),b&&b.ok?e.render():(a.completed=b.count,a.total=b.total,a.waiting=!1,e.render(b))})):d.path("sites"),a.socket=io.connect("",{reconnect:!0,forceNew:!0}),a.socket.on("notifier",function(b){switch(console.log(b),b.action){case"start":a.message=b.msg;break;case"create":a.message=b.msg;break;case"task":"site/fetch"==b.task.id&&(b.task.msg.node?(e.add({page:b.task.msg.node.page,status:b.task.msg.node.status,mime:b.task.msg.node.mime,get:b.task.msg.node.get,type:b.task.msg.node.type},b.task.msg.node.rel),a.message="GET "+b.task.msg.node.page+" "+b.task.msg.node.status+". links founded: "+b.task.msg.node.rel.length,a.completed++,a.total=visual.nodes.length):"completed"==b.task.msg&&(a.waiting=!1,a.waiting="site completed"));break;case"stop":a.waiting=!1,a.message=b.msg}a.$apply()})}]),pleni.controller("MenuController",["$scope","$rootScope","$http","$location","$window",function(a,b,c,d,e){a.items=[1,0,0,0,0,1],a.menu=function(){var b=window.location.hash.substring(1);switch(b){case"/about":a.items=[1,0,0,0,1,0];break;case"/map":a.items=[1,1,1,1,0,1];break;case"/sites":a.items=[1,0,0,0,0,1]}pushy.togglePushy()},a.hide=function(){pushy.togglePushy()},a.about=function(){pushy.togglePushy(),d.path("about")},a.home=function(){pushy.togglePushy(),d.path("")},a.close=function(){pushy.togglePushy(),c["delete"]("/").success(function(){d.path("sites"),e.location.reload()})},a.report=function(){pushy.togglePushy(),d.path("report")},a.more=function(){pushy.togglePushy(),c.put("/more").success(function(a){b.monitor=a.msg+" ",b.monitor+=0==a.queue?". starting ...":"(aprox:"+a.queue+" minutes)",d.path("/map")})},a.refresh=function(){e.location.reload()}}]),pleni.controller("ReportController",["$scope","$http","$location",function(){console.log("report")}]);var visual={init:function(){visual.tip=d3.tip().attr("class","tooltip").html(function(a){return'<div class="title">'+a.page+'</div><div class="subtle">'+(a.get?"✓":"✕")+'</div><div class="subtle">'+a.mime+"</div>"}).direction("n"),visual.canvas=document.getElementById("canvas"),visual.vis=d3.select("#canvas").append("svg:svg").attr("width","100%").attr("height","100%").attr("preserveAspectRatio","xMidYMid meet").attr("pointer-events","all").call(d3.behavior.zoom().on("zoom",function(){visual.vlinks.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),visual.vnodes.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")})).call(visual.tip),visual.vlinks=visual.vis.append("svg:g").attr("class","links"),visual.vnodes=visual.vis.append("svg:g").attr("class","nodes"),visual.legend=d3.select("#canvas").append("svg:svg").attr("width","250px"),visual.link,visual.node,visual.force=d3.layout.force().size([visual.canvas.clientWidth,visual.canvas.clientHeight]).linkDistance(200).linkStrength(1).friction(.5).charge(-2e3).gravity(.1).on("tick",visual.tick),visual.drag=visual.force.drag().on("dragstart",function(a){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("fixed",a.fixed=!0)})},tick:function(){visual.link.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),visual.node.call(function(){this.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})})},set:function(a,b,c){visual.count=a,visual.nodes=b,visual.links=c,b[0].x=~~(visual.canvas.clientWidth/2)-9,b[0].y=~~(visual.canvas.clientHeight/2)-9,b[0].fixed=!0,visual.adjacency1={},visual.adjacency2={},visual.links.forEach(function(a){visual.adjacency1[a.source.index+"_"+a.target.index]=!0,visual.adjacency2[a.target.index+"_"+a.source.index]=!0}),visual.hash1={},visual.hash2={},visual.mimes=new Array;for(var d=0;d<b.length;d++)visual.hash1[b[d].page]=d,visual.add_hash2(b[d])},add_hash2:function(a){a.mime in visual.hash2?visual.hash2[a.mime]++:(visual.hash2[a.mime]=1,visual.mimes.push(a.mime))},linked:function(a,b){return a.index+"_"+b.index in visual.adjacency1},linkin:function(a,b){return a.index+"_"+b.index in visual.adjacency2},draw:function(){visual.link=visual.vis.select(".links").selectAll("line").data(visual.links,function(a,b){return b}),visual.node=visual.vis.select(".nodes").selectAll("circle").data(visual.nodes,function(a,b){return b}),visual.link.enter().append("line").attr("class","link"),visual.link.exit().remove(),visual.node.enter().append("circle").attr("r",function(a){switch(a.type){case"root":return 18;case"page":return 12;default:return 6}}).attr("class",function(a){return["node",a.type,function(a){return"s-"+~~(a/100)}(a.status),function(a){return"m-"+a.replace("/","-")}(a.mime)].join(" ")}).on("dblclick",function(a){d3.select(this).classed("fixed",a.fixed=!1)}).on("mouseover",function(a){visual.tip.show(a),visual.link.classed("highlighted1",function(b){return b.source.index==a.index?!0:!1}),visual.link.classed("highlighted2",function(b){return b.target.index==a.index?!0:!1})}).on("mouseout",function(a){visual.tip.hide(a),visual.node.style("opacity",1),visual.link.classed("highlighted1",!1),visual.link.classed("highlighted2",!1)}).call(visual.drag),visual.node.exit().remove(),visual.force.nodes(visual.nodes).links(visual.links).start()},panel:function(){visual.legend.selectAll(".legend").remove();var a=visual.legend.selectAll(".legend").data(visual.mimes.sort()),b=a.enter().append("g").attr("class","legend").attr("transform",function(a,b){return"translate(0,"+22*b+")"});b.append("rect").attr("x",0).attr("y",0).attr("width",14).attr("height",14).attr("class",function(a){return"m-"+a.replace("/","-")}),b.append("text").attr("x",20).attr("y",11).attr("width",180).attr("height",14).text(function(a){return a}),b.append("text").attr("x",230).attr("y",11).style("text-anchor","end").text(function(a){return visual.hash2[a]}),a.exit().remove(),visual.legend.attr("height",22*visual.mimes.length+4+"px")},load:function(a){d3.json(a,function(a){visual.init(),visual.set(a.count,a.nodes,a.links),visual.draw(),visual.panel()})},add:function(a,b){var c,d;a.page in visual.hash1?(c=visual.hash1[a.page],a.mime!=visual.nodes[c]&&(visual.hash2[visual.nodes[c].mime]--,visual.add_hash2(a)),visual.nodes[c].page=a.page,visual.nodes[c].status=a.status,visual.nodes[c].mime=a.mime,visual.nodes[c].get=a.get,visual.nodes[c].type=a.type,d3.select("g.nodes>circle:nth-child("+(c+1)+")").attr("r",function(a){switch(a.type){case"root":return 18;case"page":return 12;default:return 6}}).attr("class",function(a){return["node",a.type,function(a){return"s-"+~~(a/100)}(a.status),function(a){return"m-"+a.replace("/","-")}(a.mime)].join(" ")})):(c=visual.nodes.length,visual.nodes.push(a),visual.hash1[a.page]=c,visual.add_hash2[a]),b.forEach(function(a){if(a in visual.hash1)d=visual.hash1[a];else{var b={page:a,status:"unknown",mime:"unknown",get:!1,type:"unknown"};d=visual.nodes.length,visual.nodes.push(b),visual.hash1[a]=d,visual.add_hash2(b)}visual.links.push({source:c,target:d}),visual.adjacency1[c+"_"+d]=!0,visual.adjacency2[d+"_"+c]=!0}),visual.draw(),visual.panel()}};pleni.factory("Visual",[function(){var a={page:"/",status:"unknown",mime:"unknown",get:!1,type:"unknown"},b={count:1,nodes:[a],links:[]};return{clean:function(){$("#canvas").empty()},render:function(a){a||(a=b),visual.init(),visual.set(a.count,a.nodes,a.links),visual.draw(),visual.panel()},add:function(a,b){visual.add(a,b)}}}]);